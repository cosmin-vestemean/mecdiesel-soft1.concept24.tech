<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Strategy Verification Test - ABC Analysis</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .strategy-results {
            margin: 20px 0;
        }
        .strategy-card {
            border: 1px solid #dee2e6;
            border-radius: 8px;
            margin-bottom: 15px;
            padding: 15px;
        }
        .strategy-card.active {
            border-color: #007bff;
            background-color: #f8f9fa;
        }
        .results-table {
            font-size: 0.9em;
        }
        .count-highlight {
            font-weight: bold;
            color: #007bff;
        }
        .difference-badge {
            font-size: 0.75em;
            margin-left: 5px;
        }
        .test-log {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            font-family: monospace;
            font-size: 0.85em;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <div class="container-fluid mt-4">
        <div class="row">
            <div class="col-12">
                <h1 class="mb-4">ABC Analysis Strategy Verification Test</h1>
                
                <div class="alert alert-info">
                    <h5>Purpose:</h5>
                    <p>This test verifies that all 6 Pareto display strategies produce different item counts for the same dataset.</p>
                    <p><strong>Expected:</strong> Each strategy should show a different number of items (except potentially by coincidence).</p>
                </div>

                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h5>Test Configuration</h5>
                            </div>
                            <div class="card-body">
                                <button id="loadTestData" class="btn btn-primary">Load Test Data & Run All Strategies</button>
                                <button id="clearResults" class="btn btn-secondary ms-2">Clear Results</button>
                                <div class="mt-3" id="dataInfo"></div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h5>Test Results Summary</h5>
                            </div>
                            <div class="card-body" id="summaryResults">
                                <p class="text-muted">Click "Load Test Data & Run All Strategies" to begin test</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h5>Strategy Results Comparison</h5>
                            </div>
                            <div class="card-body">
                                <div id="strategyResults"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row mt-4">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h5>Console Log</h5>
                            </div>
                            <div class="card-body">
                                <div id="testLog" class="test-log"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // Import the chart component
        import { TopAbcChart } from './public/components/top-abc/top-abc-chart.js';

        // Custom element registration
        if (!customElements.get('top-abc-chart')) {
            customElements.define('top-abc-chart', TopAbcChart);
        }

        // Test utilities
        let testLog = [];
        
        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            const logMessage = `[${timestamp}] ${message}`;
            testLog.push(logMessage);
            console.log(logMessage);
            updateLogDisplay();
        }

        function updateLogDisplay() {
            const logElement = document.getElementById('testLog');
            logElement.textContent = testLog.join('\n');
            logElement.scrollTop = logElement.scrollHeight;
        }

        // Generate synthetic test data that mimics real ABC analysis data
        function generateTestData(itemCount = 1000) {
            log(`Generating ${itemCount} test items...`);
            
            const data = [];
            let totalValue = 0;
            
            // Generate items with power-law distribution (typical for ABC analysis)
            for (let i = 0; i < itemCount; i++) {
                const rank = i + 1;
                // Power law: higher-ranked items have exponentially lower values
                const value = Math.pow(itemCount - rank + 1, 1.8) * (Math.random() * 0.5 + 0.75);
                
                data.push({
                    COD: `ITEM${String(rank).padStart(6, '0')}`,
                    DENUMIRE: `Test Item ${rank}`,
                    VALOARE: Math.round(value * 100) / 100,
                    PROCENT: 0, // Will be calculated
                    CUMULATIVEPERC: 0, // Will be calculated
                    ABC: '', // Will be calculated
                    RANK: rank
                });
                totalValue += value;
            }
            
            // Calculate percentages and cumulative percentages
            let cumulativeValue = 0;
            for (let i = 0; i < data.length; i++) {
                data[i].PROCENT = (data[i].VALOARE / totalValue) * 100;
                cumulativeValue += data[i].VALOARE;
                data[i].CUMULATIVEPERC = (cumulativeValue / totalValue) * 100;
                
                // Assign ABC classification
                if (data[i].CUMULATIVEPERC <= 80) {
                    data[i].ABC = 'A';
                } else if (data[i].CUMULATIVEPERC <= 95) {
                    data[i].ABC = 'B';
                } else {
                    data[i].ABC = 'C';
                }
            }
            
            const classACounts = data.filter(item => item.ABC === 'A').length;
            const classBCounts = data.filter(item => item.ABC === 'B').length;
            const classCCounts = data.filter(item => item.ABC === 'C').length;
            
            log(`Generated data: ${itemCount} items (A: ${classACounts}, B: ${classBCounts}, C: ${classCCounts})`);
            
            return data;
        }

        // Test all strategies
        async function testAllStrategies() {
            log('Starting strategy comparison test...');
            
            // Generate test data
            const testData = generateTestData(1000); // Use 1000 items for meaningful differences
            
            // Create a temporary chart instance for testing
            const chart = new TopAbcChart();
            chart.data = testData;
            
            // Test all strategies
            const strategies = ['top30', 'smart', 'adaptive', 'classA', 'to80percent', 'to95percent'];
            const results = [];
            
            for (const strategy of strategies) {
                log(`Testing strategy: ${strategy}`);
                chart.paretoDisplayMode = strategy;
                
                // Get strategy info
                const info = chart.getDisplayStrategyInfo(testData);
                const optimalCount = chart.getOptimalDisplayItems(testData);
                
                results.push({
                    strategy: strategy,
                    description: info.description,
                    requestedCount: info.requestedCount,
                    finalCount: optimalCount,
                    totalItems: info.totalItems,
                    coverage: ((optimalCount / info.totalItems) * 100).toFixed(1)
                });
                
                log(`  ${strategy}: ${optimalCount} items (${((optimalCount / info.totalItems) * 100).toFixed(1)}%)`);
            }
            
            displayResults(results, testData);
            return results;
        }

        function displayResults(results, testData) {
            // Update data info
            const dataInfo = document.getElementById('dataInfo');
            const classACounts = testData.filter(item => item.ABC === 'A').length;
            const classBCounts = testData.filter(item => item.ABC === 'B').length;
            const classCCounts = testData.filter(item => item.ABC === 'C').length;
            
            dataInfo.innerHTML = `
                <strong>Test Dataset:</strong><br>
                Total Items: ${testData.length}<br>
                Class A: ${classACounts} items<br>
                Class B: ${classBCounts} items<br>
                Class C: ${classCCounts} items
            `;

            // Update summary
            const summary = document.getElementById('summaryResults');
            const uniqueCounts = new Set(results.map(r => r.finalCount)).size;
            const allDifferent = uniqueCounts === results.length;
            
            summary.innerHTML = `
                <div class="alert ${allDifferent ? 'alert-success' : 'alert-warning'}">
                    <strong>Test Result: ${allDifferent ? 'PASS' : 'POTENTIAL ISSUE'}</strong><br>
                    ${uniqueCounts} unique display counts out of ${results.length} strategies<br>
                    ${allDifferent ? 'All strategies produce different item counts ✓' : 'Some strategies produce identical counts ⚠️'}
                </div>
                <div class="mt-2">
                    <strong>Range:</strong> ${Math.min(...results.map(r => r.finalCount))} - ${Math.max(...results.map(r => r.finalCount))} items
                </div>
            `;

            // Display detailed results
            const resultsContainer = document.getElementById('strategyResults');
            resultsContainer.innerHTML = `
                <table class="table table-striped results-table">
                    <thead>
                        <tr>
                            <th>Strategy</th>
                            <th>Description</th>
                            <th>Requested Count</th>
                            <th>Final Count</th>
                            <th>Coverage</th>
                            <th>Difference</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${results.map((result, index) => {
                            const prevCount = index > 0 ? results[index - 1].finalCount : result.finalCount;
                            const difference = result.finalCount - prevCount;
                            const differenceText = index === 0 ? '-' : (difference > 0 ? `+${difference}` : `${difference}`);
                            const differenceClass = difference > 0 ? 'badge bg-success' : difference < 0 ? 'badge bg-danger' : 'badge bg-secondary';
                            
                            return `
                                <tr>
                                    <td><strong>${result.strategy}</strong></td>
                                    <td>${result.description}</td>
                                    <td>${result.requestedCount}</td>
                                    <td><span class="count-highlight">${result.finalCount}</span></td>
                                    <td>${result.coverage}%</td>
                                    <td>${index === 0 ? '-' : `<span class="${differenceClass} difference-badge">${differenceText}</span>`}</td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;
        }

        // Event listeners
        document.getElementById('loadTestData').addEventListener('click', testAllStrategies);
        
        document.getElementById('clearResults').addEventListener('click', () => {
            testLog = [];
            updateLogDisplay();
            document.getElementById('dataInfo').innerHTML = '';
            document.getElementById('summaryResults').innerHTML = '<p class="text-muted">Click "Load Test Data & Run All Strategies" to begin test</p>';
            document.getElementById('strategyResults').innerHTML = '';
        });

        log('Strategy verification test page loaded');
        log('Click "Load Test Data & Run All Strategies" to begin testing');
    </script>
</body>
</html>
